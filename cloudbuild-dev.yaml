steps:
- id: 'configure-p4-gpi-app-dev'
  name: 'ubuntu'
  dir: './environments/dev/p4-gpi-app-dev'
  args:
    - '/bin/sed'
    - '-i'
    - '-r'
    - '-e'
    - 's;FROM.*;FROM ${_BUILD_NAMESPACE}/${PROJECT_ID}/p4-onbuild:develop;g'
    - 'Dockerfile'

- id: 'p4-gpi-app-dev'
  name: '${_BUILD_NAMESPACE}/cloud-builders/docker'
  args:
    - 'build'
    - '--build-arg'
    - 'GIT_REF=${_BRANCH_NAME}'
    - '--build-arg'
    - 'COMPOSER=composer-dev.json'
    - '--build-arg'
    - 'GITHUB_OAUTH_TOKEN=${_GITHUB_OAUTH_TOKEN}'
    - '--tag=${_BUILD_NAMESPACE}/${PROJECT_ID}/p4-gpi-app-dev:${_BRANCH_NAME}'
    - '--tag=${_BUILD_NAMESPACE}/${PROJECT_ID}/p4-gpi-app-dev:${_SHORT_SHA}'
    - '--tag=${_BUILD_NAMESPACE}/${PROJECT_ID}/p4-gpi-app-dev:${_BUILD_NUM}'
    - './environments/${PROJECT_ID}/p4-gpi-app'
  waitFor:
    - 'configure-p4-gpi-app-dev'

images:
  - ${_BUILD_NAMESPACE}/${PROJECT_ID}/p4-gpi-app-dev:${_BRANCH_NAME}
  - ${_BUILD_NAMESPACE}/${PROJECT_ID}/p4-gpi-app-dev:${_SHORT_SHA}
  - ${_BUILD_NAMESPACE}/${PROJECT_ID}/p4-gpi-app-dev:${_BUILD_NUM}
