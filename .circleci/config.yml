defaults: &defaults
  environment:
    GOOGLE_PROJECT_ID: planet-4-151612
    INFRA_VERSION: develop
    BUILD_FLAGS: -r
  docker:
    - image: gcr.io/planet-4-151612/p4-builder:develop
  working_directory:  /home/circleci/build/source

version: 2

jobs:
  build:
    <<: *defaults
    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: Configure gcloud
          command: |
            ${HOME}/scripts/activate-gcloud-account.sh

      - run:
          name: Build application
          working_directory: /home/circleci
          command: |
            make

  # test:
  #   <<: *defaults
  #   steps:
  #     - run:
  #         name: Placeholder
  #         command: |
  #           echo "Branch: ${CIRCLE_BRANCH}"
  #           echo "Build:  ${CIRCLE_BUILD_NUM}"
  #           echo "Tag:    ${CIRCLE_TAG}"
  #           echo "No tests implemented yet"

  deploy-develop:
    <<: *defaults
    environment:
      GOOGLE_PROJECT_ID: planet-4-151612
      BUILD_FLAGS: -r
      BUILD_ENVIRONMENT: production
    steps:
      # - checkout
      #
      # - setup_remote_docker
      #
      # - run:
      #     name: Configure gcloud
      #     command: |
      #       ${HOME}/scripts/activate-gcloud-account.sh

      - run:
          name: Build production
          command: |
            echo "@todo Update dependent repositories with new base master release"
            echo " - planet4-gpi"
            echo " - planet4-gp-greece"
            echo " - p4-handbook"
            echo "Commit changes to new tag"


workflows:
  version: 2
  build-test-and-deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/

      - deploy-develop:
          branches:
            only:
              - develop
      # - test:
      #     requires:
      #       - build
      #     filters:
      #       tags:
      #         only: /.*/
      # Only run deploy job for tagged releases on master
      - hold-production:
          type: approval
          requires:
            - build

      - deploy-production:
          requires:
            - hold-production
          filters:
            tags:
              only: /v.*/
